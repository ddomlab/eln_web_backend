<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Registry</title>
    <style>
      * {
        font-family: "Fira", monospace;
      }
      body {
        display: flex;
        flex-direction: row;
        font-family: sans-serif;
        margin: 0;
        height: 100vh;
      }
      #registry {
        width: 100px;
        background-color: #f2f2f2;
        padding: 10px;
        border-right: 2px solid #ccc;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      #registry h2 {
        font-size: 1em;
        margin-top: 0;
      }
      #registry ul {
        list-style-type: none;
        padding-left: 0;
        flex-grow: 1;
        overflow-y: auto;
      }
      #registry li {
        padding: 5px;
        background-color: #e0e0e0;
        margin-bottom: 5px;
        text-align: center;
      }
      #modeIndicator {
        font-size: 0.9em;
        text-align: center;
        margin-top: 10px;
        font-weight: bold;
        margin-bottom: 5px;
      }
      #main {
        flex-grow: 1;
        padding: 10px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      #inputProcessor {
        margin-bottom: 10px;
        height: 30px;
        font-size: 1em;
        width: 100%;
      }
      #qrGrid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
      .qrItem {
        display: flex;
        flex-direction: column;
        align-items: center; /* Horizontal centering */
        justify-content: center; /* Vertical if needed */
        cursor: pointer;
      }
      .qrWrapper {
        padding: 10px;
      }
      #popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 2px solid #ccc;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        display: none;
        z-index: 1000;
      }
      #popup h3 {
        margin-top: 0;
      }
      #popupGrid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 10px;
      }
      #popupClose {
        margin-top: 15px;
        text-align: center;
        cursor: pointer;
        color: #0077cc;
      }
      #successPopup {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #4caf50;
        color: white;
        padding: 10px 16px;
        border-radius: 5px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        display: none;
        font-size: 0.9em;
        z-index: 2000;
        transition: opacity 0.5s ease;
      }
      #unsuccessPopup {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #d42c26;
        color: white;
        padding: 10px 16px;
        border-radius: 5px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        display: none;
        font-size: 0.9em;
        z-index: 2000;
        transition: opacity 0.5s ease;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  </head>
  <body>
    <div id="registry">
      <div>
        <h2>Registry</h2>
        <ul id="registryList"></ul>
      </div>
      <div id="modeIndicator">Mode: Single</div>
    </div>
    <div id="main">
      <input
        type="text"
        id="inputProcessor"
        placeholder="Input Processor"
        autofocus
      />
      <div id="qrGrid"></div>
    </div>

    <div id="popup">
      <h3>Additional QR Codes</h3>
      <div id="popupGrid"></div>
      <div id="popupClose">Close</div>
    </div>
    <div id="successPopup">Success!</div>
    <div id="unsuccessPopup">Success!</div>
    <div
      id="experimentPrompt"
      style="
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border: 2px solid #ccc;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        z-index: 1001;
      "
    >
      <label for="experimentInput">Enter Experiment ID:</label>
      <input
        type="number"
        id="experimentInput"
        style="margin: 10px 0; width: 100%"
      />
      <div style="text-align: right">
        <button onclick="submitExperiment()">Submit (or press [ENTER])</button>
        <div id="cancelQr" onclick="cancelExperiment()" class="qrItem"></div>
      </div>
    </div>

    <script>
      function getCookie(name) {
        const match = document.cookie
          .split("; ")
          .find((row) => row.startsWith(name + "="));
        return match && decodeURIComponent(match.split("=")[1]);
      }
      const apiKey = getCookie("apiKey");
      if (!apiKey) {
        alert(
          'API key not found. Please click "Add Resource", where you can find a textbox to enter your API key.'
        );
      }
      const captions = [
        //"Voice Mode",
        "Clear",
        "Batch",
        "Add resource",
        //"Change Status",
        "Mark Open",
        "Mark Empty",
        "Print",
        "Open Page",
        //"Add Tag",
        "Associate with Experiment",
      ];
      const extraCaptions = ["Option 1", "Option 2", "Option 3", "Option 4"];
      const qrGrid = document.getElementById("qrGrid");
      const popupGrid = document.getElementById("popupGrid");
      const inputProcessor = document.getElementById("inputProcessor");
      const registryList = document.getElementById("registryList");
      const modeIndicator = document.getElementById("modeIndicator");
      const popup = document.getElementById("popup");
      const popupClose = document.getElementById("popupClose");

      let registryMode = "single";
      let voiceMode = false;
      let focusOnInput = true;
      function clearRegistry() {
        registryList.innerHTML = "";
      }
      function updateModeIndicator() {
        highlightWrapperByCaption("Batch", registryMode === "batch" ? "#dfedda" : "#ffffff  ");
        modeIndicator.textContent = `Mode: ${
          registryMode.charAt(0).toUpperCase() + registryMode.slice(1)
        }`;
      }
      function beep(tone1, tone2, type) {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const aosc = ctx.createOscillator();
        const eosc = ctx.createOscillator();
        const gain = ctx.createGain();

        aosc.type = type;
        eosc.type = type;
        aosc.frequency.setValueAtTime(tone1, ctx.currentTime); // 880 Hz = A5 note
        eosc.frequency.setValueAtTime(tone2, ctx.currentTime); // 1319 Hz = E6 note

        gain.gain.setValueAtTime(0.2, ctx.currentTime); // Lower volume

        eosc.connect(gain);
        aosc.connect(gain);
        gain.connect(ctx.destination);

        eosc.start(ctx.currentTime + 0.15);
        aosc.start();
        aosc.stop(ctx.currentTime + 0.15); // 150ms beep
        eosc.stop(ctx.currentTime + 0.3); // 150ms beep
      }

      function success(message = "Success!") {
        const popup = document.getElementById("successPopup");
        popup.textContent = message;
        popup.style.display = "block";
        popup.style.opacity = "1";

        // const audio = new Audio("https://cdn.pixabay.com/download/audio/2021/08/04/audio_9b7b3c3f2e.mp3?filename=success-1-6297.mp3");
        // audio.play();
        beep(880, 1319, "sine");
        setTimeout(() => {
          popup.style.opacity = "0";
        }, 1200);

        setTimeout(() => {
          popup.style.display = "none";
        }, 1800);
      }

      function speak(text) {
        if (!voiceMode) return;
        const utterance = new SpeechSynthesisUtterance(text);
        speechSynthesis.speak(utterance);
      }

      function error() {
        const popup = document.getElementById("unsuccessPopup");
        popup.textContent = "Failed!";
        popup.style.display = "block";
        popup.style.opacity = "1";
        beep(440, 370, "square");
        setTimeout(() => {
          popup.style.opacity = "0";
        }, 1200);
        setTimeout(() => {
          popup.style.display = "none";
        }, 1800);
      }

      function addToRegistry(num) {
        const existingItems = [...registryList.children];
        const exists = existingItems.some((li) => li.textContent === num);
        if (exists) {
          existingItems.forEach((li) => {
            if (li.textContent === num) {
              li.remove();
              if (!voiceMode) {
                beep(380, 370, "square");
              }
              speak("removed");
            }
          });
          return;
        }
        if (registryMode === "single") {
          const occupied = registryList.innerHTML !== "";
          clearRegistry();
          if (occupied) {
            speak("replaced");
            if (!voiceMode) {
              beep(440, 450, "sine");
            }
          }
        }
        const li = document.createElement("li");
        li.textContent = num;
        registryList.appendChild(li);
      }

      function handleInputSubmission(value) {
        let val = value.trim().toLowerCase();
        if (val.startsWith("https://eln.ddomlab.org/")) {
          val = val.split("id=")[1];
        }

        if (val === "voice mode") {
          voiceMode = !voiceMode;
          speak("Voice mode " + (voiceMode ? "enabled" : "disabled"));
          inputProcessor.value = "";
          inputProcessor.focus();
          return;
        } else if (val === "clear") {
          clearRegistry();
          // success();
        } else if (val === "batch") {
          registryMode = registryMode === "single" ? "batch" : "single";
          speak(registryMode);
          updateModeIndicator();
          if (registryMode === "single") {
            clearRegistry();
          }
        } else if (val === "on_batch") {
          registryMode = "batch";
          updateModeIndicator();
          success();
        } else if (val === "on_single") {
          registryMode = "single";
          // speak(registryMode);
          updateModeIndicator();

          clearRegistry();
          success();
        } else if (val === "add resource") {
          window.location.href = "/add_resource_interface";
        } else if (val === "open page") {
          const ids = [...registryList.children].map((li) => li.textContent);
          if (ids.length === 0) {
            error();
          }
          ids.forEach((id) => {
            if (!isNaN(id) && id !== "") {
              window.open(
                `https://eln.ddomlab.org/database.php?mode=view&id=${id}`,
                "_blank"
              );
            }
          });
        } else if (val === "print") {
          const ids = [...registryList.children].map((li) => li.textContent);
          fetch("/print", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id: ids }),
          })
            .then((response) => {
              if (!response.ok) {
                error();
                throw new Error("Print request failed");
              }
              console.log("Print request sent");
              return response.blob();
            })
            .then((blob) => {
              const pdfUrl = URL.createObjectURL(blob);
              window.open(pdfUrl, "_blank");
            })
            .catch((err) => {
              console.error("Error sending print request:", err);
            });
        } else if (val === "mark open") {
          const ids = [...registryList.children].map((li) => li.textContent);
          fetch("/mark_open", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id: ids }),
          }).then((response) => {
            if (!response.ok) {
              error();
              throw new Error("Failed");
            } else {
              success();
            }
          });
        } else if (val === "mark empty") {
          const ids = [...registryList.children].map((li) => li.textContent);
          fetch("/mark_empty", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id: ids }),
          }).then((response) => {
            if (!response.ok) {
              error();
              throw new Error("Failed");
            } else {
              success();
            }
          });
        } else if (val === "associate with experiment") {
          const ids = [...registryList.children].map((li) => li.textContent);
          if (ids.length === 0) {
            error();
          } else {
            showExperimentPrompt();
          }
        } else if (val === "add tag") {
          const ids = [...registryList.children].map((li) => li.textContent);
          return;
        } else if (!isNaN(val) && val !== "") {
          addToRegistry(val);
        }
        inputProcessor.value = "";
        if (focusOnInput) {
          inputProcessor.focus();
        }
      }

      function showExperimentPrompt() {
        focusOnInput = false;
        const input = document.getElementById("experimentInput");
        input.value = "";
        document.getElementById("experimentPrompt").style.display = "block";
        input.addEventListener("keydown", experimentKeyListener);
        renderQRCode(document.getElementById("cancelQr"), "CANCEL");
        input.focus();
      }
      function experimentKeyListener(e) {
        if (e.key === "Enter") {
          submitExperiment();
        }
      }
      function cancelExperiment() {
        const input = document.getElementById("experimentInput");
        input.removeEventListener("keydown", experimentKeyListener); // ðŸ”§ Clean up
        document.getElementById("experimentPrompt").style.display = "none";
        document.getElementById("cancelQr").innerHTML = "";

        focusOnInput = true;
      }

      function submitExperiment() {
        const expId = document.getElementById("experimentInput").value;
        if (!expId || isNaN(expId)) {
          error();
          cancelExperiment();
          focusOnInput = true;
          return;
        }

        const ids = [...registryList.children].map((li) => li.textContent);
        if (ids.length === 0) {
          error();
          cancelExperiment();
          focusOnInput = true;
          return;
        }

        fetch("/associate", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            id: ids,
            exp_id: expId,
          }),
        })
          .then((response) => {
            if (!response.ok) {
              error();
              throw new Error("Association failed");
            } else {
              exp_name = response.headers.get("exp_name");
              success("Associated with experiment: " + exp_name);
            }
          })
          .catch((err) => {
            console.error(err);
          })
          .finally(() => {
            cancelExperiment();
          });
      }

      inputProcessor.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          handleInputSubmission(e.target.value);
        }
      });

      function renderQRCode(container, caption) {
        const canvasWrapper = document.createElement("div");
        canvasWrapper.className = "qrWrapper";
        canvasWrapper.style.display = "inline-block"; // Shrinks to fit content
        // canvasWrapper.style.margin = "10px"; // Adjust as needed

        const canvas = document.createElement("canvas");
        canvasWrapper.appendChild(canvas);

        const label = document.createElement("div");
        label.textContent = caption;

        container.appendChild(canvasWrapper);
        container.appendChild(label);

        container.addEventListener("click", () => {
          inputProcessor.value = caption;
          handleInputSubmission(caption);
        });

        QRCode.toCanvas(canvas, caption, { width: 128 }, (err) => {
          if (err) console.error(err);
        });
      }
      function highlightWrapperByCaption(targetCaption, color) {
        // Find all qrItem containers
        const qrItems = document.querySelectorAll(".qrItem");

        qrItems.forEach((item) => {
          const label = item.querySelector("div:last-child");
          if (label && label.textContent === targetCaption) {
            const wrapper = item.querySelector(".qrWrapper");
            if (wrapper) {
              wrapper.style.backgroundColor = color;
            }
          }
        });
      }

      captions.forEach((caption) => {
        const container = document.createElement("div");
        container.className = "qrItem";
        qrGrid.appendChild(container);
        renderQRCode(container, caption);

        if (caption === "Change Status") {
          container.addEventListener("click", () => {
            popup.style.display = "block";
            popupGrid.innerHTML = "";
            extraCaptions.forEach((extra) => {
              const extraContainer = document.createElement("div");
              extraContainer.className = "qrItem";
              renderQRCode(extraContainer, extra);
              popupGrid.appendChild(extraContainer);
            });
          });
        }
      });

      popupClose.addEventListener("click", () => {
        popup.style.display = "none";
        if (focusOnInput) inputProcessor.focus();
      });

      window.addEventListener("click", () => {
        if (focusOnInput) {
          inputProcessor.focus();
        }
      });

      updateModeIndicator();
    </script>
  </body>
</html>
